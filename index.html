<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Lithuanian Verbs</title>
  <script src="https://cdn.jsdelivr.net/npm/sql.js@1.10.2/dist/sql-wasm.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sql.js-httpvfs@0.8.17/dist/sql-httpvfs.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body { font-family: 'Inter', sans-serif; transition: background-color 0.3s, color 0.3s; }
    #main-content { height: 100vh; display: flex; flex-direction: column; }
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; }
    ::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
    .dark ::-webkit-scrollbar-track { background: #2d3748; }
    .dark ::-webkit-scrollbar-thumb { background: #718096; }
  </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 antialiased">

<div id="access-denied" class="hidden fixed inset-0 bg-gray-100 dark:bg-gray-900 flex items-center justify-center z-50 text-center p-4">
    <div>
        <p class="text-2xl font-bold text-red-600 dark:text-red-500">Access Denied</p>
        <p class="mt-2 text-gray-600 dark:text-gray-400">You do not have permission to use this application.</p>
    </div>
</div>

<div id="main-content" class="mx-auto max-w-7xl flex flex-col h-screen">
  <header class="p-4 bg-gray-100 dark:bg-gray-900 border-b border-gray-200 dark:border-gray-700">
    <h1 class="text-xl sm:text-2xl font-bold text-sky-700 dark:text-sky-300 text-center">
      Lithuanian Verbs Search
    </h1>
    <div class="mt-4 relative">
      <input type="text" id="searchInput" placeholder="Search any form..." class="w-full p-3 pl-10 text-base border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 placeholder-gray-400 dark:placeholder-gray-500 transition-all" />
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 dark:text-gray-500"><path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" /></svg>
    </div>
     <div id="error-container" class="mt-2 p-2 bg-red-100 dark:bg-red-800 border border-red-300 dark:border-red-600 text-red-700 dark:text-red-200 rounded-md text-sm hidden"></div>
  </header>

  <div id="table-wrapper-container" class="p-4 flex-grow flex flex-col overflow-hidden">
    <div id="table-wrapper" class="overflow-x-auto overflow-y-auto flex-grow bg-white dark:bg-gray-800 rounded-lg shadow-md">
        <div id="loading-indicator" ...>...</div>
        <div id="no-results-message" ...>...</div>
        <table class="min-w-full text-sm table-fixed">
            <thead id="table-head" class="bg-gray-50 dark:bg-gray-700 sticky top-0 z-10"></thead>
            <tbody id="table-body" ...></tbody>
        </table>
    </div>
    <p id="record-count" class="mt-4 text-xs text-gray-500 dark:text-gray-400 text-center flex-shrink-0"></p>
  </div>
</div>

<div id="modal-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
    <div id="modal-content" class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col">
        <div class="flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700">
            <h2 id="modal-title" class="text-xl font-semibold text-gray-800 dark:text-gray-200"></h2>
            <button id="modal-close-button" class="text-gray-500 hover:text-gray-800 dark:hover:text-gray-200 text-3xl leading-none">&times;</button>
        </div>
        <div id="modal-body" class="p-4 overflow-y-auto"></div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', async () => {

    // === ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ И НАСТРОЙКИ ===
    let worker;
    // !!! ОБЯЗАТЕЛЬНО УБЕДИТЕСЬ, ЧТО ЭТО ПРАВИЛЬНЫЙ URL ВАШЕГО РЕПОЗИТОРИЯ !!!
    const DB_URL = 'https://yurinick.github.io/lithuanian-verbs-app/verbs.sqlite';
    const TENSE_TRANSLATIONS = {
        "Present tense": "Настоящее время", "Past tense": "Прошедшее время",
        "Future tense": "Будущее время", "Conditional mood": "Сослагательное наклонение",
        "Imperative mood": "Повелительное наклонение", "Past freq. tense": "Прошедшее многократное время"
    };
    // Имена столбцов из нашей новой базы данных
    const mainTableHeaders = ['id_num', 'p_val', 'hash_val', 'infinitive', 'present_3rd', 'past_3rd', 'question', 'translation'];

    // === ССЫЛКИ НА ЭЛЕМЕНТЫ DOM ===
    const searchInput = document.getElementById('searchInput');
    const tableHead = document.getElementById('table-head');
    const tableBody = document.getElementById('table-body');
    const loadingIndicator = document.getElementById('loading-indicator');
    const noResultsMessage = document.getElementById('no-results-message');
    const errorContainer = document.getElementById('error-container');
    const recordCount = document.getElementById('record-count');
    const modalOverlay = document.getElementById('modal-overlay');
    const modalTitle = document.getElementById('modal-title');
    const modalBody = document.getElementById('modal-body');
    const modalCloseButton = document.getElementById('modal-close-button');
    const showError = (message) => { errorContainer.textContent = message; errorContainer.classList.remove('hidden'); };

    // === ИНТЕГРАЦИЯ С TELEGRAM (без изменений) ===
    try {
        const tg = window.Telegram.WebApp;
        tg.ready();
        const applyTheme = () => document.body.classList.toggle('dark', tg.colorScheme === 'dark');
        tg.onEvent('themeChanged', applyTheme);
        applyTheme();
        tg.MainButton.setText('Закрыть').setTextColor('#ffffff').setColor('#0ea5e9').show();
        tg.onEvent('mainButtonClicked', () => tg.close());
    } catch (e) { console.log("Not in Telegram environment."); }

    // === НОВАЯ ЛОГИКА РАБОТЫ С БАЗОЙ ДАННЫХ ===
    async function initDatabase() {
        try {
            loadingIndicator.textContent = 'Connecting to database...';
            // Используем cdnjs для стабильности
            const workerUrl = 'https://cdnjs.cloudflare.com/ajax/libs/sql.js-httpvfs/0.8.17/sqlite.worker.js';
            const wasmUrl = 'https://cdnjs.cloudflare.com/ajax/libs/sql.js-httpvfs/0.8.17/sql-wasm.wasm';

            worker = await createDbWorker(
                [{ httpUrl: DB_URL, serverHttpHeaders: {}, databaseLength: 12000000, timeout: 5000 }],
                workerUrl, wasmUrl
            );
            
            loadingIndicator.textContent = 'Loading initial data...';
            // Используем id_num, как мы назвали его в Python
            const initialData = await worker.db.query('SELECT * FROM verbs ORDER BY id_num LIMIT 500;');
            renderTable(initialData);
        } catch(e) {
            console.error('Database initialization failed:', e);
            showError('Failed to initialize database. Please check console for details.');
        } finally {
            loadingIndicator.classList.add('hidden');
        }
    }

    // === НОВАЯ ЛОГИКА ПОИСКА ===
    let debounceTimer;
    searchInput.addEventListener('input', (event) => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(async () => {
            const searchTerm = event.target.value.trim();
            if (!searchTerm) {
                const initialData = await worker.db.query('SELECT * FROM verbs ORDER BY id_num LIMIT 500;');
                renderTable(initialData);
                return;
            }
            const searchQuery = searchTerm.split(' ').filter(Boolean).map(word => `${word}*`).join(' ');
            const results = await worker.db.query(
                `SELECT v.* FROM verbs_fts fts JOIN verbs v ON fts.rowid = v.rowid WHERE fts.verbs_fts MATCH ? ORDER BY rank`, 
                [searchQuery]
            );
            renderTable(results);
        }, 300);
    });

    // === ФУНКЦИИ РЕНДЕРИНГА (адаптированы под новые данные) ===
    function renderTable(dataToRender) {
        tableHead.innerHTML = '';
        tableBody.innerHTML = '';

        const headerRow = document.createElement('tr');
        mainTableHeaders.forEach((headerText) => {
            const th = document.createElement('th');
            th.className = 'py-3 text-center text-xs font-semibold text-sky-700 dark:text-sky-300 uppercase tracking-wider';
            // Простое присвоение имени, без сложной логики
            th.classList.add('px-2');
            th.textContent = headerText.replace('_', ' ').replace('val', ''); // Делаем заголовки красивее
            headerRow.appendChild(th);
        });
        tableHead.appendChild(headerRow);

        dataToRender.forEach(row => {
            const tr = document.createElement('tr');
            tr.className = 'hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors duration-150 even:bg-gray-50 dark:even:bg-gray-700';

            // Если есть спряжения, делаем строку кликабельной
            if (row.conjugations) {
                tr.classList.add('cursor-pointer');
                tr.addEventListener('click', () => showModalForVerb(row));
            }
            
            mainTableHeaders.forEach(headerKey => {
                const td = document.createElement('td');
                td.className = 'px-2 py-2 text-center text-gray-700 dark:text-gray-300 break-words';
                if (headerKey.includes('infinitive') || headerKey.includes('translation')) {
                    td.classList.add('text-left'); // Длинные тексты выравниваем по левому краю
                }
                td.textContent = row[headerKey] || '';
                tr.appendChild(td);
            });
            tableBody.appendChild(tr);
        });
        
        noResultsMessage.classList.toggle('hidden', dataToRender.length === 0);
        recordCount.textContent = `Showing ${dataToRender.length} results.`;
    }

    const normalizeForMatch = (str) => str ? str.normalize('NFD').replace(/[\u0300-\u036f]/g, '') : '';
    const getPreferredForm = (formsArray) => {
        if (!formsArray || formsArray.length === 0) return '-';
        const formWithDiacritics = formsArray.find(form => form !== normalizeForMatch(form));
        return formWithDiacritics || formsArray[0];
    };

    function showModalForVerb(rowData) {
        const verbInfo = JSON.parse(rowData.conjugations || '{}');
        modalTitle.textContent = `${rowData.infinitive} - ${rowData.translation}`;
        modalBody.innerHTML = '';

        const tenses = {
            "Present tense": verbInfo["Present tense"], "Past tense": verbInfo["Past tense"],
            "Future tense": verbInfo["Future tense"], "Conditional mood": verbInfo["Conditional mood"],
            "Imperative mood": verbInfo["Imperative mood"], "Past freq. tense": verbInfo["Past freq. tense"]
        };
        
        const mainTenses = ["Present tense", "Past tense", "Future tense", "Conditional mood"];
        const persons = ["Aš", "Tu", "Jis/ji", "Mes", "Jūs", "Jie/jos"];
        let tableHTML = `<div class="overflow-x-auto"><table class="min-w-full text-sm divide-y divide-gray-200 dark:divide-gray-700 mb-4">`;
        tableHTML += `<thead class="bg-gray-50 dark:bg-gray-700"><tr><th class="px-2 py-1"></th>`;
        mainTenses.forEach(tense => {
            tableHTML += `<th class="px-2 py-1 text-left text-xs font-semibold text-sky-700 dark:text-sky-300">${TENSE_TRANSLATIONS[tense] || tense}</th>`;
        });
        tableHTML += `</tr></thead><tbody class="divide-y divide-gray-200 dark:divide-gray-700">`;
        persons.forEach((person, personIndex) => {
            tableHTML += `<tr class="hover:bg-gray-100 dark:hover:bg-gray-600 even:bg-gray-50 dark:even:bg-gray-600">`;
            tableHTML += `<td class="px-2 py-1 font-semibold">${person}</td>`;
            mainTenses.forEach(tense => {
                const tenseData = tenses[tense];
                const item = tenseData && tenseData[personIndex] ? tenseData[personIndex] : null;
                const form = item ? getPreferredForm(item.forms) : '-';
                tableHTML += `<td class="px-2 py-1">${form}</td>`;
            });
            tableHTML += `</tr>`;
        });
        tableHTML += `</tbody></table></div>`;
        modalBody.innerHTML = tableHTML;
        
        ["Imperative mood", "Past freq. tense"].forEach(tense => {
            if (tenses[tense] && tenses[tense].length > 0) {
                let tenseHTML = `<h3 class="text-lg font-semibold mt-4 mb-2 text-sky-600 dark:text-sky-400">${TENSE_TRANSLATIONS[tense] || tense}</h3>`;
                tenseHTML += `<table class="min-w-full text-sm"><tbody class="divide-y divide-gray-200 dark:divide-gray-700">`;
                tenses[tense].forEach(row => {
                    tenseHTML += `<tr class="hover:bg-gray-100 dark:hover:bg-gray-600 even:bg-gray-50 dark:even:bg-gray-600"><td class="px-2 py-1 w-1/4 font-semibold">${row.person}</td><td class="px-2 py-1">${getPreferredForm(row.forms)}</td></tr>`;
                });
                tenseHTML += `</tbody></table>`;
                modalBody.innerHTML += tenseHTML;
            }
        });
        modalOverlay.classList.remove('hidden');
    }

    function closeModal() { modalOverlay.classList.add('hidden'); }
    modalCloseButton.addEventListener('click', closeModal);
    modalOverlay.addEventListener('click', (e) => { if (e.target === modalOverlay) closeModal(); });
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && !modalOverlay.classList.contains('hidden')) closeModal(); });

    // === НАЧАЛЬНЫЙ ЗАПУСК ===
    initDatabase();
});
</script>
</body>
</html>